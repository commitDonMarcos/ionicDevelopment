<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Student Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="goToChangePassword()">CHANGE PASSWORD</ion-button>
      <ion-button (click)="logout()">LOGOUT</ion-button>
      <ion-button (click)="openAnnouncements()">
        <ion-icon name="notifications-outline"></ion-icon>

        <!-- Badge if unread -->
        <ion-badge *ngIf="unreadCount > 0" color="danger" class="notif-badge">
          {{ unreadCount }}
        </ion-badge>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <h2>Welcome, {{ student?.studentName || student?.username }}</h2>

  <!-- ğŸ”¹ Active Tasks -->
  <ion-item-divider color="light">
    <ion-label><strong>Active Tasks</strong></ion-label>
  </ion-item-divider>

  <ion-card *ngFor="let task of tasks">
    <ion-card-header>
      <ion-card-title>{{ task.title }}</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <p>Deadline: {{ task.deadline | date: 'medium' }}</p>
      <p>
        Items: {{ task.items?.length || 1 }} Â· Questions: {{
        task.questions?.length || 1 }}
      </p>

      <div class="ion-margin-top">
        <ion-button color="success" fill="clear" (click)="takeTask(task)">
          TAKE TASK
        </ion-button>
        <ion-button color="tertiary" fill="clear" (click)="viewAnalysis(task)">
          VIEW ANALYSIS
        </ion-button>
      </div>

      <hr />

      <div *ngIf="getResultForTask(task.id) as result; else notTaken">
        <p>
          <strong>Your Score:</strong> {{ result.score }}/{{ result.total }}
        </p>
        <p>
          <strong>Status:</strong>
          {{ result.passed ? 'âœ… Passed' : 'âŒ Failed' }}
        </p>
        <p><strong>Date Taken:</strong> {{ result.date | date: 'medium' }}</p>
      </div>

      <ng-template #notTaken>
        <p><em>No result yet for this task.</em></p>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <!-- ğŸ”¹ Task History -->
  <ion-item-divider color="light" *ngIf="pastTasks.length > 0">
    <ion-label><strong>Task History</strong></ion-label>
  </ion-item-divider>

  <ion-card *ngFor="let past of pastTasks">
    <ion-card-header>
      <ion-card-title>{{ past.title }}</ion-card-title>
      <ion-note color="danger">
        Expired: {{ past.deadline | date: 'medium' }}
      </ion-note>
    </ion-card-header>

    <ion-card-content>
      <p><strong>Status:</strong> Closed</p>

      <div *ngIf="getResultForTask(past.id) as result; else noHistoryResult">
        <p>
          <strong>Your Score:</strong> {{ result.score }}/{{ result.total }}
        </p>
        <p>
          <strong>Result:</strong>
          {{ result.passed ? 'âœ… Passed' : 'âŒ Failed' }}
        </p>
        <p><strong>Date Taken:</strong> {{ result.date | date: 'medium' }}</p>
      </div>

      <ng-template #noHistoryResult>
        <p><em>You didnâ€™t take this task.</em></p>
      </ng-template>
    </ion-card-content>
  </ion-card>
</ion-content>
